<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<title>BlockBlast Web</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
/* ===================== ROOT VARIABLE ===================== */
:root{
    --bg: #111827;
    --board-color: #1f2937;
    --block-color: #4D96FF;
    --glow: #ffffff88;
    --text: #fff;
}

.light {
    --bg: #f2f2f2;
    --text: #000;
    --board-color: #ddd;
}

/* ===================== LAYOUT ===================== */
body {
    margin: 0;
    font-family: Arial;
    background: var(--bg);
    color: var(--text);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px 0;
    user-select: none;
}

/* Title */
h1 {
    margin-bottom: 10px;
    font-size: 32px;
    text-shadow: 0 0 10px #000;
}

/* Board 9x9 */
.board {
    width: 360px;
    height: 360px;
    background: var(--board-color);
    display: grid;
    grid-template-columns: repeat(9, 1fr);
    gap: 1px;
    padding: 6px;
    border-radius: 12px;
    transition: 0.3s;
}

.flash {
    animation: flashBoard 0.3s ease;
}

@keyframes flashBoard {
    0% { filter: brightness(2); }
    100% { filter: brightness(1); }
}

.cell {
    width: 100%;
    padding-bottom: 100%;
    background: #00000022;
    border: 1px solid rgba(255,255,255,0.18);
    border-radius: 4px;
    position: relative;
    transition: 0.1s;
}

.cell.filled {
    background: var(--block-color);
    box-shadow: 0 0 10px var(--block-color);
}

.cell.glow {
    box-shadow: inset 0 0 10px var(--glow);
}

/* Bottom blocks */
.block-area {
    margin-top: 20px;
    display: flex;
    gap: 20px;
}

.block {
    display: inline-grid;
    gap: 2px;
    padding: 8px;
    border-radius: 10px;
    background: #ffffff15;
    cursor: grab;
}

.block div {
    width: 26px;
    height: 26px;
    background: var(--block-color);
    border-radius: 4px;
}

.hidden {
    opacity: 0;
}

/* Score */
.score-box {
    margin: 20px 0;
    font-size: 20px;
    text-align: center;
}

button {
    padding: 6px 12px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    margin-top: 10px;
    font-weight: bold;
}
</style>
</head>
<body>

<h1>BlockBlast Web</h1>

<div class="score-box">
    Điểm: <span id="score">0</span><br>
    Best: <span id="best">0</span><br>
    Combo: <span id="combo">x1</span>
</div>

<button onclick="toggleTheme()">Dark / Light</button>

<!-- BOARD -->
<div id="board" class="board"></div>

<!-- BLOCKS -->
<div id="blocks" class="block-area"></div>

<script>
/* ============================================================
    GAME DATA
============================================================ */
let board = Array.from({ length: 9 }, () => Array(9).fill(0));
let currentBlocks = [];
let draggedBlock = null;
let dragOffset = { x: 0, y: 0 };

let score = 0;
let combo = 1;

let best = localStorage.getItem("best-blast") || 0;
document.getElementById("best").innerText = best;

/* Colors */
const COLORS = [
    "#FF6B6B", "#FFD93D", "#6BCB77",
    "#4D96FF", "#9D4EDD", "#F72585"
];

function randomColor() {
    return COLORS[Math.floor(Math.random() * COLORS.length)];
}

/* ============================================================
    BOARD RENDER
============================================================ */
const boardDiv = document.getElementById("board");

function renderBoard() {
    boardDiv.innerHTML = "";
    for (let r = 0; r < 9; r++) {
        for (let c = 0; c < 9; c++) {
            let cell = document.createElement("div");
            cell.className = "cell";
            if (board[r][c] === 1) cell.classList.add("filled");
            boardDiv.appendChild(cell);
        }
    }
}

renderBoard();

/* ============================================================
    BLOCK GENERATION
============================================================ */
const BLOCK_SHAPES = [
    [[1]],
    [[1,1]],
    [[1,1,1]],
    [[1],[1]],
    [[1],[1],[1]],
    [[1,1],[1,0]],
    [[1,1],[0,1]],
    [[1,1,1],[0,1,0]],
];

function generate3Blocks() {
    currentBlocks = [];
    for (let i = 0; i < 3; i++) {
        currentBlocks.push(BLOCK_SHAPES[Math.floor(Math.random()*BLOCK_SHAPES.length)]);
    }
    renderBlocks();
}

function renderBlocks() {
    let area = document.getElementById("blocks");
    area.innerHTML = "";

    currentBlocks.forEach((shape, index) => {
        if (!shape) return;

        let b = document.createElement("div");
        b.className = "block";
        b.dataset.index = index;

        b.style.gridTemplateColumns = `repeat(${shape[0].length}, 1fr)`;

        shape.forEach(row => {
            row.forEach(cell => {
                let d = document.createElement("div");
                if (cell === 0) d.style.visibility = "hidden";
                b.appendChild(d);
            });
        });

        b.onmousedown = startDrag;
        area.appendChild(b);
    });
}

generate3Blocks();

/* ============================================================
    DRAGGING
============================================================ */
let ghost;

function startDrag(e) {
    draggedBlock = this;
    ghost = this.cloneNode(true);

    ghost.style.position = "absolute";
    ghost.style.pointerEvents = "none";
    ghost.style.opacity = 0.8;
    ghost.style.left = e.pageX + "px";
    ghost.style.top = e.pageY + "px";

    document.body.appendChild(ghost);

    document.onmousemove = dragMove;
    document.onmouseup = endDrag;
}

function dragMove(e) {
    if (!ghost) return;

    ghost.style.left = e.pageX - 20 + "px";
    ghost.style.top = e.pageY - 20 + "px";

    highlightPossible(e.pageX, e.pageY);
}

function endDrag(e) {
    clearGlow();

    if (!ghost || !draggedBlock) return;

    let rect = boardDiv.getBoundingClientRect();
    let x = e.clientX - rect.left;
    let y = e.clientY - rect.top;

    let cellX = Math.floor(x / (rect.width / 9));
    let cellY = Math.floor(y / (rect.height / 9));

    let index = draggedBlock.dataset.index;
    let shape = currentBlocks[index];

    if (placeBlock(shape, cellY, cellX)) {
        currentBlocks[index] = null;
        renderBlocks();
    }

    document.body.removeChild(ghost);
    ghost = null;
    draggedBlock = null;

    // Kiểm tra nếu không còn block nào → tạo block mới
    if (currentBlocks.every(b => b === null)) {
        generate3Blocks();
    }
}

/* ============================================================
    PLACE BLOCK
============================================================ */
function canPlace(shape, r, c) {
    for (let i = 0; i < shape.length; i++) {
        for (let j = 0; j < shape[0].length; j++) {
            if (shape[i][j] === 1) {
                if (r+i >= 9 || c+j >= 9) return false;
                if (board[r+i][c+j] === 1) return false;
            }
        }
    }
    return true;
}

function placeBlock(shape, r, c) {
    if (!canPlace(shape, r, c)) return false;

    for (let i = 0; i < shape.length; i++)
        for (let j = 0; j < shape[0].length; j++)
            if (shape[i][j] === 1)
                board[r+i][c+j] = 1;

    score += countCells(shape) * combo;
    document.getElementById("score").innerText = score;

    clearLines();
    renderBoard();
    saveBest();
    return true;
}

function countCells(shape) {
    let sum = 0;
    shape.forEach(row => row.forEach(c => sum += c));
    return sum;
}

/* ============================================================
    CLEAR LINES + COMBO
============================================================ */
function clearLines() {
    let cleared = false;

    // ROWS
    for (let r = 0; r < 9; r++) {
        if (board[r].every(v => v === 1)) {
            for (let c = 0; c < 9; c++) board[r][c] = 0;
            cleared = true;
        }
    }

    // COLUMNS
    for (let c = 0; c < 9; c++) {
        let ok = true;
        for (let r = 0; r < 9; r++)
            if (board[r][c] === 0) ok = false;
        if (ok) {
            for (let r = 0; r < 9; r++) board[r][c] = 0;
            cleared = true;
        }
    }

    if (cleared) {
        combo++;
        document.getElementById("combo").innerText = "x" + combo;

        // Đổi màu board + block
        let newColor = randomColor();
        document.documentElement.style.setProperty("--block-color", newColor);
        document.documentElement.style.setProperty("--board-color", newColor + "33");

        boardDiv.classList.add("flash");
        setTimeout(()=> boardDiv.classList.remove("flash"), 300);
    } 
    else {
        combo = 1;
        document.getElementById("combo").innerText = "x1";
    }
}

/* ============================================================
    VISUAL GLOW
============================================================ */
function clearGlow() {
    document.querySelectorAll(".cell").forEach(c => c.classList.remove("glow"));
}

function highlightPossible(px, py) {
    clearGlow();

    if (!draggedBlock) return;

    let rect = boardDiv.getBoundingClientRect();
    let x = px - rect.left;
    let y = py - rect.top;

    let cellX = Math.floor(x / (rect.width / 9));
    let cellY = Math.floor(y / (rect.height / 9));

    let shape = currentBlocks[draggedBlock.dataset.index];
    if (!shape) return;

    if (!canPlace(shape, cellY, cellX)) return;

    // highlight
    for (let i = 0; i < shape.length; i++)
        for (let j = 0; j < shape[0].length; j++)
            if (shape[i][j] === 1) {
                let index = (cellY+i) * 9 + (cellX+j);
                let c = boardDiv.children[index];
                if (c) c.classList.add("glow");
            }
}

/* ============================================================
    SAVE BEST
============================================================ */
function saveBest() {
    if (score > best) {
        best = score;
        localStorage.setItem("best-blast", best);
        document.getElementById("best").innerText = best;
    }
}

/* ============================================================
    THEME TOGGLE
============================================================ */
function toggleTheme() {
    document.body.classList.toggle("light");
}
</script>

</body>
</html>
